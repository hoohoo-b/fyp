<!DOCTYPE HTML>
<meta charset="utf-8">
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<body>
<svg width="960" height="960"></svg>
<button id="random-btn" style="position: absolute; top: 0; right: 0;">Randomize Data</button>
<style>
        circle {
            fill: rgb(31, 119, 180);
            fill-opacity: .25;
            stroke: rgb(31, 119, 180);
            stroke-width: 1px;
        }

        .leaf circle {
            fill: #ff7f0e;
            fill-opacity: 1;
        }

        text {
            font: 10px sans-serif;
            text-anchor: middle;
        }
</style>
<script type="text/javascript">
  var root, data2;

  var svg = d3.select("svg"),
    diameter = +svg.attr("width"),
    g = svg.append("g").attr("transform", "translate(2,2)"),
    format = d3.format(",d");

  var pack = d3.pack()
    .size([diameter - 4, diameter - 4]);

d3.json("flare.json", function(error, data) {
	if (error) throw error;
	data2 = data;
  function update() {
    root = d3.hierarchy(data)
      .sum(function(d) {
        return d.size;
      })
      .sort(function(a, b) {
        return b.value - a.value;
      });

    var nodes = g.selectAll(".nodes")
      .data(pack(root).descendants())
      .enter().append("g")
      .attr("class", function(d) {
        return d.children ? "nodes" : "leaf nodes";
      })
      .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
			
		var nodesUpdate = g.selectAll(".nodes")
		.attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });;
		
		var circleUpdate = nodesUpdate.select("circle")
		.attr("r", function(d) {
        return d.r;
      });
			

    nodes.append("title")
      .text(function(d) {
        return d.data.name + "\n" + format(d.value);
      });

    nodes.append("circle")
      .attr("r", function(d) {
        return d.r;
      });

    nodes.filter(function(d) {
      return !d.children;
    }).append("text")
      .attr("dy", "0.3em")
      .text(function(d) {
        return d.data.name.substring(0, d.r / 3);
      });
  }

  update(data);

  d3.select('#random-btn').on('click', function() { 
    (function randomizeNode(node) {
        if (node.size) {
          node.size *= Math.random() * 10;
        }
        if (node.children) {
          node.children.forEach(function(childNode) {
            randomizeNode(childNode);
          });
        }
    }(data));
    console.log('updated data');
    update(data);
    // data should be updated, now update vis
  });
});
</script>